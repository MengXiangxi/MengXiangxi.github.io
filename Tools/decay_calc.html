<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/w3.css">
    <link rel="stylesheet" href="../css/mengfront.css">
    <title>Radioactive decay Calculator</title>
</head>

<body>
    <div class="w3-display-topmiddle w3-mobile">
        <div class="w3-container w3-center">
            <h1>Radioactive Decay Calculator</h1>
            <p>Created by Xiangxi Meng, Beijing Cancer Hospital</p>
        </div>
        <div class="w3-mobile w3-center meng-color-theme">
            <a href="https://mengxiangxi.info/"
                class="w3-bar-item w3-button">Home</a>
        </div>
        <!-- </div>

    <div class="w3-display-topmiddle w3-mobile"> -->
        <div class="w3-container w3-padding">
            先凑合凑合。
        </div>
        <div class="w3-container">
            <form>
                <div class="w3-card w3-padding">
                    <h3>Calculate the injected amount</h3>
                    <label for="CalculateUnit">Unit:</label><br />
                    <select name="CalculateUnit" id="Unit" onchange="dispUnit(); calculateInj();">
                        <option value="Bq">Bq</option>
                        <option value="kBq">kBq</option>
                        <option value="MBq">MBq</option>
                        <option value="GBq">GBq</option>
                        <option value="TBq">TBq</option>
                        <option value="muCi">μCi</option>
                        <option value="mCi" selected>mCi</option>
                        <option value="Ci">Ci</option>
                    </select><br />
                    <label for="NuclideType">Nuclide type:</label><br />
                    <select name="NuclideType" id="NuclideType" onchange="dispNuclide(); calculateInj();">
                        <option value="Specify">Custom</option>
                        <option value="C11">C-11</option>
                        <option value="F18" selected>F-18</option>
                        <option value="Cu64">Cu-64</option>
                        <option value="Ga68">Ga-68</option>
                        <option value="Y90">Y-90</option>
                        <option value="Zr89">Zr-89</option>
                        <option value="Tc99m">Tc-99m</option>
                        <option value="I124">I-124</option>
                        <option value="I125">I-125</option>
                        <option value="I131">I-131</option>
                        <option value="Lu177">Lu-177</option>
                    </select>
                    <label for="HalfLife">Half-life of the selected nuclide:</label><br />
                    <fieldset id="HalfLife" disabled style="border: 0px;">
                        <input type="number" id="Year" value=0 style="width: 6em;" />Year(s)
                        <input type="number" id="Day" value=0 style="width: 6em;" />Day(s)<br />
                        <input type="number" id="Hour" value=0 style="width: 6em;" />h
                        <input type="number" id="Min" value=109.771 style="width: 6em;" />min
                        <input type="number" id="Sec" value=0 style="width: 6em;" />s
                    </fieldset>
                    <hr />
                    Measured<br />
                    <label for="TimeMeasure">Time</label>
                    <input type="datetime-local" value="1970-01-01T00:00:00" step="1" id="TimeMeasure" onchange="calculateInj()" />
                    <label for="DoseMeasure">Dose</label>
                    <input type="number" name="DoseMeasure" id="DoseMeasure" value="1" style="width: 6em;" onchange="calculateInj()" />
                    <label for="DoseMeasure" id="UnitMeasure"> mCi</label><br />
                    Injected<br />
                    <label for="TimeInj">Time</label>
                    <input type="datetime-local" value="1970-01-01T00:00:00" step="1" id="TimeInj" onchange="calculateInj()" />
                    <label for="DoseInj">Dose</label>
                    <input type="number" id="DoseInj" value="0" style="width: 6em;" disabled />
                    <select name="InjUnit" id="InjUnit" onchange="calculateInj()">
                        <option value="Bq">Bq</option>
                        <option value="kBq">kBq</option>
                        <option value="MBq">MBq</option>
                        <option value="GBq">GBq</option>
                        <option value="TBq">TBq</option>
                        <option value="muCi">μCi</option>
                        <option value="mCi" selected>mCi</option>
                        <option value="Ci">Ci</option>
                    </select><br />
                    Residue<br />
                    <label for="TimeRes">Time</label>
                    <input type="datetime-local" value="1970-01-01T00:00:00" step="1" id="TimeRes" onchange="calculateInj()" />
                    <label for="DoseRes">Dose</label>
                    <input type="number" name="DoseMeasure" id="DoseRes" value="1" style="width: 6em;" onchange="calculateInj()" />
                    <label for="DoseRes" id="UnitRes"> mCi</label>
                    <hr />
                    <button type="button" onclick="calculateInj()" class="w3-padding">Find Injected Dose</button><br />
                </div>
            </form>
        </div>


        <div class="w3-container w3-center" sytle="font-size:9px">
            <hr />
            Meng Xiangxi, 20211107
        </div>
    </div>

</body>
<script>
    const currentDateTime = () => {
        var tzoffset = new Date().getTimezoneOffset() * 60000; //offset in milliseconds
        var localISOString = new Date(Date.now() - tzoffset)
            .toISOString()
            .slice(0, -1);

        // convert to YYYY-MM-DDTHH:MM
        const datetimeInputString = localISOString.substring(
            0,
            ((localISOString.indexOf("T") | 0) + 6) | 0
        );
        console.log(datetimeInputString);
        return datetimeInputString;
    };

    document.getElementById('TimeMeasure').value = currentDateTime();
    document.getElementById('TimeRes').value = currentDateTime();
    document.getElementById('TimeInj').value = currentDateTime();

    function dispUnit(){
        document.getElementById('UnitMeasure').textContent = document.getElementById('Unit').value;
        document.getElementById('UnitRes').textContent = document.getElementById('Unit').value;
        document.getElementById('InjUnit').value = document.getElementById('Unit').value;
    }

    function dispNuclide() {
        var nuclide = document.getElementById("NuclideType").value;
        switch (nuclide) {
            case 'C11':
                setNuclide(0, 0, 0, 20.38, 0, 11.01, true);
                break;
            case 'F18':
                setNuclide(0, 0, 0, 109.771, 0, 18.00, true);
                break;
            case 'Cu64':
                setNuclide(0, 0, 12.7801, 0, 0, 63.929764, true);
                break;
            case 'Ga68':
                setNuclide(0, 0, 0, 67.71, 0, 67.92798, true);
                break;
            case 'Tc99m':
                setNuclide(0, 0, 6.0067, 0, 0, 98.9063, true);
                break;
            case 'Y90':
                setNuclide(0, 0, 64.6, 0, 0, 89.9071519, true);
                break;
            case 'Zr89':
                setNuclide(0, 0, 78.41, 0, 0, 88.908890, true);
                break;
            case 'I124':
                setNuclide(0, 4.176, 0, 0, 0, 123.9062099, true);
                break;
            case 'I125':
                setNuclide(0, 59.49, 0, 0, 0, 124.9046302, true);
                break;
            case 'I131':
                setNuclide(0, 8.0197, 0, 0, 0, 130.9061246, true);
                break;
            case 'Lu177':
                setNuclide(0, 6.6475, 0, 0, 0, 176.9437581, true);
                break;
            case 'Specify':
                setNuclide(0, 0, 0, 0, 0, 0, false);
                break;
        }
    }

    function setNuclide(year, day, hour, min, sec, au, edit = true) {
        document.getElementById("Year").value = year;
        document.getElementById("Day").value = day;
        document.getElementById("Hour").value = hour;
        document.getElementById("Min").value = min;
        document.getElementById("Sec").value = sec;
        document.getElementById("HalfLife").disabled = edit;
    }

    function calculateInj(){
        var doseMeasure, doseRes, timeMeasure, timeInj, TimeRes;
        doseMeasure = document.getElementById('DoseMeasure').value;
        timeMeasure = new Date(document.getElementById('TimeMeasure').value);
        timeInj = new Date(document.getElementById('TimeInj').value);
        doseRes = document.getElementById('DoseRes').value;
        timeRes = new Date(document.getElementById('TimeRes').value);

        var durMeasure, durRes;
        durMeasure = (timeInj - timeMeasure)/1000;
        durRes = (timeInj - timeRes)/1000;

        var iyear, iday, ihour, imin, isec, halflife;
        iyear = document.getElementById("Year").value;
        iday = document.getElementById("Day").value;
        ihour = document.getElementById("Hour").value;
        imin = document.getElementById("Min").value;
        isec = document.getElementById("Sec").value;
        halflife = iyear * 31536000 + iday * 86400 + ihour * 3600 + imin * 60 + isec;

        var dcdose, dcMeasure, dcRes;
        dcMeasure = decay(doseMeasure, halflife, durMeasure);
        dcRes = decay(doseRes, halflife, durRes);
        dcdose = dcMeasure - dcRes;

        var unit1, unit2, doseInj;
        unit1 = document.getElementById('Unit').value;
        unit2 = document.getElementById('InjUnit').value;
        doseInj = dcdose*convert_factor(unit1)/convert_factor(unit2);
        document.getElementById('DoseInj').value = doseInj;
    }

    function decay(original, halflife, dur){
        return original*2**(-dur/halflife)
    }

    function convert_factor(unit){
        switch (unit) {
            case 'Bq':
                return 1;
                break;
            case 'kBq':
                return 1e3;
                break;
            case 'MBq':
                return 1e6;
                break;
            case 'GBq':
                return 1e9;
                break;
            case 'TBq':
                return 1e12;
                break;
            case 'muCi':
                return 3.7e4;
                break;
            case 'mCi':
                return 3.7e7;
                break;
            case 'Ci':
                return 3.7e10;
                break;
        }
    }
</script>

</html>